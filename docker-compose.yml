version: '3.8'

services:
  # MongoDB Database
  mongodb:
    image: mongo:7.0
    container_name: ehr-mongodb
    restart: unless-stopped
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
      - mongodb_config:/data/configdb
    environment:
      - MONGO_INITDB_DATABASE=ehr_database
    networks:
      - ehr-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # EHR CRUD Service (gRPC Server)
  ehr-crud-service:
    build:
      context: ./ehr-crud-service
      dockerfile: Dockerfile
    container_name: ehr-crud-service
    restart: unless-stopped
    ports:
      - "50051:50051"
    environment:
      - MONGODB_URL=mongodb://mongodb:27017
      - DATABASE_NAME=ehr_database
      - GRPC_HOST=0.0.0.0
      - GRPC_PORT=50051
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - ehr-network
    healthcheck:
      test: ["CMD", "python", "-c", "import socket; sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM); sock.settimeout(2); result = sock.connect_ex(('localhost', 50051)); sock.close(); exit(0 if result == 0 else 1)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # API Gateway Service (FastAPI)
  api-gateway-service:
    build:
      context: ./api-gateway-service
      dockerfile: Dockerfile
    container_name: api-gateway-service
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      - GRPC_HOST=ehr-crud-service
      - GRPC_PORT=50051
      - API_HOST=0.0.0.0
      - API_PORT=8080
    depends_on:
      ehr-crud-service:
        condition: service_healthy
    networks:
      - ehr-network
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8080/', timeout=2)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

# Networks
networks:
  ehr-network:
    driver: bridge
    name: ehr-network

# Volumes
volumes:
  mongodb_data:
    driver: local
    name: ehr-mongodb-data
  mongodb_config:
    driver: local
    name: ehr-mongodb-config
